(in-package #:with-c-syntax.stdlib)

(defun va_start (ap last)
  (declare (ignorable last))
  (declare (type list ap))
  (unless (length= 1 ap)
    (error "va_start: bad args: (~S, ~S)" ap last))
  `(get-varargs ,(first ap)))

(defun va_arg (ap type)
  (declare (ignorable type))
  (declare (type list ap))
  (unless (length= 1 ap)
    (error "va_arg: bad args: (~S, ~S)" ap type))
  `(pop ,(first ap)))

(defun va_end (ap)
  (declare (type list ap))
  (unless (length= 1 ap)
    (error "va_end: bad args: (~S)" ap))
  `(setf ,(first ap) nil))

(defun va_copy (dest src)
  (declare (type list dest src))
  (unless (and (length= 1 dest)
               (length= 1 src))
    (error "va_copy: bad args: (~S, ~S)" dest src))
  `(setf ,(first dest) (copy-list ,(first src))))

(eval-when (:load-toplevel :execute)
  (define-predefined-typedef-and-aliases '|va_list| 'list)
  (define-preprocessor-macro "VA_START" #'va_start t)
  (define-preprocessor-macro "va_start" #'va_start)
  (define-preprocessor-macro "VA_ARG" #'va_arg t)
  (define-preprocessor-macro "va_arg" #'va_arg)
  (define-preprocessor-macro "VA_END" #'va_end t)
  (define-preprocessor-macro "va_end" #'va_end)
  (define-preprocessor-macro "VA_COPY" #'va_copy t)
  (define-preprocessor-macro "va_copy" #'va_copy)
  )
